<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Migrating from state_machine to aasm in Rails &#8211; eLitmus Blog</title>
<meta name="description" content="We learn new things everyday, and we document our learnings here...">

<meta name="keywords" content="State Machine, Ruby on Rails, Rails 5">

<!-- Twitter Cards -->
  <meta name="twitter:card" content="summary">    
<meta name="twitter:title" content="Migrating from state_machine to aasm in Rails">
<meta name="twitter:description" content="<p><strong><em>First things first. State machines are awesome, be it any part of technology you use them in.</em></strong></p>

">
<meta name="twitter:site" content="@elitmus">

    

    

    

    

    

    
        
            <meta name="twitter:creator" content="@akkee19">
        
    

    

    

    

    




<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:image" content="/blog/images/blog_logo_taglinedorange.png"/>
<meta property="og:type" content="article">
<meta property="og:title" content="Migrating from state_machine to aasm in Rails">
<meta property="og:description" content="<p><strong><em>First things first. State machines are awesome, be it any part of technology you use them in.</em></strong></p>

">
<meta property="og:url" content="/blog/technology/migrating-from-state-machine-to-aasm-in-rails/">

<meta property="og:site_name" content="eLitmus Blog">







<link rel="canonical" href="https://www.elitmus.com/blog/technology/migrating-from-state-machine-to-aasm-in-rails/">
<link href="/blog/feed.xml" type="application/atom+xml" rel="alternate" title="eLitmus Blog Feed">


	<link rel="author" href="https://plus.google.com/+eLitmus?rel=author">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Icons -->
<!-- apple touch icons -->
<link rel="apple-touch-icon" sizes="57x57" href="/blog/images/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/blog/images/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/blog/images/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/blog/images/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/blog/images/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/blog/images/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/blog/images/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/blog/images/apple-touch-icon-152x152.png">
<!-- Favicons default 16x16 -->
<link rel="shortcut icon" type="image/vnd.microsoft.icon" href="/blog/favicon.ico">

<!-- Favicons others -->
<link rel="icon" type="image/png" href="/blog/images/favicon-196x196.png" sizes="196x196">
<link rel="icon" type="image/png" href="/blog/images/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/blog/images/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/blog/images/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/blog/images/favicon-32x32.png" sizes="32x32">

<!-- Icons for Windows 8 Tiles -->
<meta name="msapplication-TileColor" content="#ffffff"/>
<meta name="msapplication-TileImage" content="/blog/images/mstile-144x144.png">

<!-- For all browsers -->


<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:600,300,300italic|The+Girl+Next+Door" rel="stylesheet" type="text/css">
<link href='//fonts.googleapis.com/css?family=Source+Code+Pro:300' rel='stylesheet' type='text/css'>

<meta http-equiv="cleartype" content="on">

<!-- bootstrap 4 -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap.min.css">

<!-- below css file is used for navbar in individual blogposts -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/main.min.css">

<!-- <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css"> -->

<!-- Optional theme -->
<link rel="stylesheet" type="text/css" href="/blog/assets/css/bootstrap-theme.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Font Awesome -->
<link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/blog/assets/css/font-elitmuslogo.css" />

<link rel="stylesheet" href="/blog/assets/css/customize.css">
<link rel="stylesheet" href="/blog/assets/css/forkit.css">
</head>

<body id="post">

  <header class="headroom">

  <nav class="navbar navbar-expand-md navbar-dark bg-black fixed-top" role="navigation">

      <a class="navbar-brand" href="/blog/">
        <img src="https://cdn0.elitmus.net/assets/elitmus-only-logo-6efc8a74032179afdb89829a093e05bd05d627dd4354bbd1ff7f4eb5db8a0af8.svg" class="img-logo">
        <span><div class="blog-label">blog</div></span>
      </a>

      <!-- the toggle button -->
      <button type="button" class="navbar-toggler" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="navbar-toggler-icon"></span>
        <span class="sr-only">Toggle navigation</span><!-- only for screen readers -->
      </button>

      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav mr-auto">

          <!-- first item = dropdown search -->
          <li class="nav-item">
            <div class="dropdown search-box-margin">

            
              <div class="form-inline">
                 

                <input data-toggle="dropdown" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">


                <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
                </div>

              </div>



            <!-- the below line will pass "search word" to search.html -->

            <!--
            <form class="form-inline" action="/blog/search" method="get">
               


              <label for="search_box">Search</label>
              <input data-toggle="dropdown" type="text" name="query" placeholder="Search..." id="search-box" class="form-control form-control-sm search-input dropdown-toggle" aria-haspopup="true" aria-expanded="false">

              <div class="dropdown-menu" id="search-dropdown">
                  <a role='presentation' class='dropdown-item search-results'> Type more.... </a>
              </div>

              <input type="submit" value="search">

            </form>
            -->

            <!-- end of form -->


            </div>
          </li>
        </ul>

        

        <!-- every link on the right side -->
        <ul class="nav navbar-nav navbar-right nav-icon-size-reduce">
          
          <li class="nav-item">
             
              <a href="/blog/" class="nav-link">
                <i class="fa fa-home"></i> Home
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="/blog/posts/" class="nav-link">
                <i class="fa fa-file-text-o"></i> Posts
              </a>
            
          </li>
          
          <li class="nav-item">
             
              <a href="//www.elitmus.com/" class="nav-link">
                <i class="el el-elitmuslogo"></i> eLitmus
              </a>
            
          </li>
          

          <!-- feed is the last link -->
          <li class="nav-item">
            <a href="/blog/feed.xml" class="nav-link" title="Atom/RSS feed">
              <i class="fa fa-rss"></i> Feed
            </a>
          </li>
        </ul>



      </div> <!-- /.navbar-collapse -->

  </nav><!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
</header>
<!-- 

  <div class="search-wrapper">
    <div class="search-form">
      <input type="text" class="search-field" placeholder="Search...">
      <i class="icon-remove-sign icon-2x"></i>
      <ul class="search-results post-list"></ul> -->
<!-- /.search-results -->
<!-- </div> -->
<!-- /.search-form -->
<!-- </div> -->
<!-- ./search-wrapper -->
<!--  -->

  

  <div class="container-fluid">

  <div class="row">


    <div class="col-md-2"></div>
      <div class="col-md-8">
        

        <div id="main" role="main" class="marginal">
          <article class="entry">

            

            <div>
              <header>
                <span class="entry-tags">
                  
                    <a href="/blog/tags/#State Machine" title="Pages tagged State Machine">State Machine</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#Ruby on Rails" title="Pages tagged Ruby on Rails">Ruby on Rails</a>
                    &nbsp;&bull;&nbsp;
                  
                    <a href="/blog/tags/#Rails 5" title="Pages tagged Rails 5">Rails 5</a>
                    
                  

                  <div class=' social-sharing pull-right'>        
     
</div>

                </span>
              
                
                  <h1 class="no-padding">Migrating from state_machine to aasm in Rails</h1>
                
              </header>
            </div>
           
            <div>
              <div>
                <span class='badge badge-warning'> <a href="/blog/categories/technology/index.html" > technology </a></span>
              </div>

              

              <div class="post-content-justify">
                <p><strong><em>First things first. State machines are awesome, be it any part of technology you use them in.</em></strong></p>

<p>Recently at work, we passed many pipelines on migrating a very large Rails app from Rails 4 to Rails 5. One of the major parts of this change was shifting from <code>state_machine</code> to <code>aasm</code> for our state transitions. We rely heavily on state machines for how our instances shift states. Much of our tasks associated with the models too are integrated with the after/before actions of our state machines.</p>

<p><img src="/blog/images/aasm_migration/state_machine_diagram.png" alt="Generated using https://github.com/Katee/aasm-diagram" /></p>

<h3 id="need-for-transition">Need for transition:</h3>

<p>One and only one reason, <a href="https://github.com/pluginaweek/state_machine"><code>state_machine</code></a> has been dead, and for quite some time. We shifted from Rails 3.2 to Rails 4.2 last year, and since it was a really, really painful migration, we fixed our focus on changed syntax and <code>ActiveJob</code>, found the much famous <a href="https://github.com/pluginaweek/state_machine/issues/334#issuecomment-68168119">monkeypatch</a> for Rails 4.2 and stayed happy for the time being with state_machine. Though there is <a href="https://github.com/state-machines/state_machines-activerecord">state_machines_activerecord</a>, we wanted to move to a more reliable and tested library, and as we already use <a href="https://github.com/state-machines/state_machines-activerecord">acts_as_state_machine</a> or <code>aasm</code> in one of our other projects, we tried and gave it a shot, when we began our Rails 5 voyage, for which of course neither state_machine and its patch worked, nor it was recommended.</p>

<h3 id="what-changed">What changed:</h3>

<p>As it turned out, the process was not too messy. After a small study of the way both state_machine and aasm handle state transitions, one can easily find an analogy. Here are a few things which usually are a part of a state_machine laden project and how they should be modified to work with aasm</p>

<p><strong>1. The gem itself</strong></p>

<p>Goes without saying, remove from your <code>Gemfile/gems.rb</code> :</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="n">gem</span> <span class="s1">&#39;state_machine&#39;</span></code></pre></figure>

<p>and add :</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="n">gem</span> <span class="s1">&#39;aasm&#39;</span></code></pre></figure>

<p><strong>2. Get rid of the state_machine monkey-patch if present</strong></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">module</span> <span class="nn">StateMachine</span>
    <span class="k">module</span> <span class="nn">Integrations</span>
      <span class="k">module</span> <span class="nn">ActiveModel</span>
        <span class="kp">public</span> <span class="ss">:around_validation</span>
      <span class="k">end</span>
      <span class="k">module</span> <span class="nn">ActiveRecord</span>
        <span class="kp">public</span> <span class="ss">:around_save</span>
        <span class="k">def</span> <span class="nf">define_state_initializer</span>
          <span class="n">define_helper</span> <span class="ss">:instance</span><span class="p">,</span> <span class="o">&lt;&lt;-</span><span class="dl">end_eval</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">,</span> <span class="bp">__LINE__</span> <span class="o">+</span> <span class="mi">1</span>
<span class="sh">            def initialize(*)</span>
<span class="sh">              super do |*args|</span>
<span class="sh">                self.class.state_machines.initialize_states self</span>
<span class="sh">                yield(*args) if block_given?</span>
<span class="sh">              end</span>
<span class="sh">            end</span>
<span class="dl">          end_eval</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span></code></pre></figure>

<p>Yes, get rid of this if you have it, most probably in one of your <code>config/initializers</code>.</p>

<p><strong>3. Transitioning the transitions:</strong></p>

<p>This is the major part of the change and yet the easiest to implement. This includes code change in models. Take a look at the documentation over at aasm and start changing the code. Here are a few pointers.</p>

<p>add <code>include AASM</code> to your model</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>
  <span class="k">end</span></code></pre></figure>

<p>specify the column name on which you are observing state transitions, for eg. if the column name is <code>state</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>
    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="o">...</span>
  <span class="k">end</span></code></pre></figure>

<p>Initiate your state machine block by listing out all your states. The common way is using one line to specify your initial state, and a second line to list all your non-initial states</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>
    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="n">aasm</span> <span class="k">do</span>
      <span class="n">state</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="kp">true</span>
      <span class="n">state</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="p">,</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:removed</span>
      <span class="o">...</span>
    <span class="k">end</span>
    <span class="o">...</span>
  <span class="k">end</span></code></pre></figure>

<p>Convert your events. All event blocks of the form transition <code>:a =&gt; :b</code> will be replaced by transitions <code>from: :a, to: :b</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>

    <span class="c1"># State machine code</span>

    <span class="n">state_machine</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="ss">:authored</span> <span class="k">do</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span>
      <span class="k">end</span>

      <span class="n">event</span> <span class="ss">:activate</span> <span class="k">do</span>
        <span class="n">transition</span> <span class="o">[</span><span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="ss">:active</span>
      <span class="k">end</span>

      <span class="o">..</span>
    <span class="k">end</span>


   <span class="c1"># AASM code</span>

    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="n">aasm</span> <span class="k">do</span>
      <span class="n">state</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="kp">true</span>
      <span class="n">state</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="p">,</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:removed</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:piloted</span>
      <span class="k">end</span>

      <span class="n">event</span> <span class="ss">:activate</span> <span class="k">do</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="o">[</span><span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="o">]</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:active</span>
      <span class="k">end</span>

      <span class="o">...</span>
    <span class="k">end</span>
    <span class="o">...</span>
  <span class="k">end</span></code></pre></figure>

<p>Callbacks like <code>before_transition</code> and <code>after_transition</code> from state_machine can be converted like this:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>

    <span class="c1"># State machine code</span>

    <span class="n">state_machine</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="ss">:authored</span> <span class="k">do</span>
      <span class="n">before_transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:do</span> <span class="o">=&gt;</span> <span class="ss">:prepare_cockpit</span>
      <span class="n">after_transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:do</span> <span class="o">=&gt;</span> <span class="ss">:fly_the_plane</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span>
      <span class="k">end</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="c1"># AASM code</span>

    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="n">aasm</span> <span class="k">do</span>
      <span class="n">state</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="kp">true</span>
      <span class="n">state</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="p">,</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:removed</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">before</span> <span class="k">do</span>
          <span class="n">prepare_cockpit</span>
        <span class="k">end</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="ss">:fly_the_plane</span>
      <span class="k">end</span>

      <span class="o">...</span>
    <span class="k">end</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">prepare_cockpit</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">fly_the_plane</span>
      <span class="o">...</span>
    <span class="k">end</span>


  <span class="k">end</span></code></pre></figure>

<p>However, in case of callbacks on a part of a transitions defined inside an event, one needs to define the transitions separately</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>

    <span class="c1"># State machine code</span>

    <span class="n">state_machine</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="ss">:authored</span> <span class="k">do</span>
      <span class="n">after_transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:do</span> <span class="o">=&gt;</span> <span class="ss">:fly</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transition</span> <span class="o">[</span><span class="ss">:inactive</span><span class="p">,</span> <span class="ss">:authored</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span>
      <span class="k">end</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="c1"># AASM code</span>

    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="n">aasm</span> <span class="k">do</span>
      <span class="n">state</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="kp">true</span>
      <span class="n">state</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="p">,</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:removed</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">after</span><span class="p">:</span> <span class="ss">:fly</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:piloted</span>
      <span class="k">end</span>

      <span class="o">...</span>
    <span class="k">end</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">fly</span>
      <span class="o">...</span>
    <span class="k">end</span>

  <span class="k">end</span></code></pre></figure>

<p><code>if</code> and <code>unless</code> guard blocks on transitions work the same way as in state_machine, and can also be substituted with a guard clause. The guards as well as callbacks can take arguments, <code>lambda</code> as well as <code>Proc</code>, same as the state machine guards</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="k">class</span> <span class="nc">Question</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="kp">include</span> <span class="no">AASM</span>
    <span class="o">...</span>

    <span class="c1"># State machine code</span>

    <span class="n">state_machine</span> <span class="ss">:state</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="ss">:authored</span> <span class="k">do</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transition</span> <span class="ss">:authored</span> <span class="o">=&gt;</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="k">if</span><span class="p">:</span> <span class="ss">:can_fly?</span>
      <span class="k">end</span>
      <span class="o">...</span>
    <span class="k">end</span>

    <span class="c1"># AASM code</span>

    <span class="n">aasm</span><span class="o">.</span><span class="n">attribute_name</span> <span class="ss">:state</span>
    <span class="n">aasm</span> <span class="k">do</span>
      <span class="n">state</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">initial</span><span class="p">:</span> <span class="kp">true</span>
      <span class="n">state</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">:non_active</span><span class="p">,</span> <span class="ss">:active</span><span class="p">,</span> <span class="ss">:removed</span>

      <span class="n">event</span> <span class="ss">:pilot</span> <span class="k">do</span>
        <span class="n">transitions</span> <span class="ss">from</span><span class="p">:</span> <span class="ss">:authored</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:piloted</span><span class="p">,</span> <span class="ss">guard</span><span class="p">:</span> <span class="ss">:can_fly?</span>
      <span class="k">end</span>

      <span class="o">...</span>
    <span class="k">end</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">can_fly?</span>
      <span class="o">...</span>
    <span class="k">end</span>

  <span class="k">end</span></code></pre></figure>

<p>Yes, that’s it for the models. You can take a detailed look at the docs if you have more complex needs.</p>

<p><strong>4. The helpers:</strong></p>

<p>One plus point for <code>state_machine</code> , it has/had a variety of useful helpers for making use of states and events in views and controllers. <code>aasm</code>, though lagging behind a little in this domain, still has a good pool of helpers, both <code>class</code> and <code>instance</code> to make good use of. Here are some pointers.</p>

<ul>
  <li><code>Question.aasm.states</code> will give you an object list of all states available for the <code>Question</code> model</li>
  <li><code>Question.aasm.events</code> will give you an object list of all events available for the <code>Question</code> model</li>
  <li><code>Question.first.aasm.states</code> will give an object list of all states available for transitioning to for a <code>Question</code> object, in this case the first one.</li>
  <li><code>Question.first.aasm.events</code> will give an object list of all events that can be applied on the current state of the <code>Question</code> object, i.e the first</li>
  <li>All of the above helpers will produce an object list that contains name as the name of object, so appending <code>.map(&amp;:name)</code> will give a symbol array of the name of objects, that will come handy in drop-downs. Eg.</li>
</ul>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">Question</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">aasm</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:name</span><span class="p">)</span>
  <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:pilot</span><span class="p">,</span> <span class="ss">:deactivate</span><span class="o">]</span></code></pre></figure>

<p>Another great point in favor of <code>state_machine</code> is its <code>state_event</code> attribute over the instance. For eg.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">question</span> <span class="o">=</span> <span class="no">Question</span><span class="o">.</span><span class="n">first</span>
  <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">question</span><span class="o">.</span><span class="n">state_event</span> <span class="o">=</span> <span class="ss">:deactivate</span>
  <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">question</span><span class="o">.</span><span class="n">save</span></code></pre></figure>

<p>The code above will end up saving the question after calling the <code>deactivate</code> event over it. This attribute is highly useful in rails forms where one can easily pass what event to call from, and the transition will happen without extra hassle. Unfortunately, there’s no equivalent attribute cum method in aasm . But one can always write a common <code>ActiveRecord::Base</code> helper for the same.</p>

<p>On another note, the not-so-good-looking <code>with_state</code> / <code>with_states</code> scope methods of <code>state_machine</code> can be replaced by the enum equivalent syntax of <code>aasm</code> . For eg.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="no">Question</span><span class="o">.</span><span class="n">with_state</span><span class="p">(</span><span class="ss">:active</span><span class="p">)</span> <span class="c1"># state_machine</span></code></pre></figure>

<p>gets replaced by a much cleaner :</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span></span>  <span class="no">Question</span><span class="o">.</span><span class="n">active</span></code></pre></figure>

<p>So yes, a couple of tweaks here and there, and a good pool of existing test cases which run green, you are done and production ready. This will get you started, but do back yourself up with the aasm docs.</p>

              </div>
              <div class="entry-tags">
                <div class=' social-sharing pull-right'>        
     
</div>
              </div>
              <div class="clearfix"><br/></div>

                <div class="panel panel-default">

  

  

  

  

  

  
    
      <div class="panel-body">
        <div class="container-fluid">

          <div class="row">
            <div class="col-sm-12 col-md-4">
              <center>
                <img src="/blog/images/akash.jpg" alt="Akash Srivastava photo" class="author-photo img-circle img-responsive"/>
                
                <span class="author vcard">
                  <span class="fn">Akash Srivastava</span>
                </span>

                <div class="nav-icon-size-reduce social-icons">
                  
                    <a href="https://twitter.com/akkee19"  title="Akash Srivastava on Twitter"  target="_blank"><i class="fa fa-twitter "></i></a>
                  
                  
                  
                  

                  
                    <a href="https://linkedin.com/in/akash-srivastava-640aa826" title="Akash Srivastava on LinkedIn" target="_blank"><i class="fa fa-linkedin "></i></a>
                  

                  

                  

                  

                  
                    <a href="https://github.com/akkee" title="Akash Srivastava on Github" target="_blank"><i class="fa fa-github "></i></a>
                  

                     
                </div><!-- /.social-icons -->
              </center>
            </div>

            <div class="col-sm-12 col-md-8">
              
                <span class="author-bio">Akash Srivastava is a member of Technology at eLitmus. He is passionate about anything remotely related to movies when sane, and resorts to competitive coding and writing blogs when sleepless.</span>
              
            </div>

          </div>

        </div>
      </div>

  

  

  

  

  

</div>
                <div id='discourse-comments'></div>

<script type="text/javascript">
  DiscourseEmbed = { discourseUrl: 'https://adda.elitmus.com/',
                     discourseEmbedUrl: 'https://www.elitmus.com/blog/technology/migrating-from-state-machine-to-aasm-in-rails/'
                   };

  (function() {
    var d = document.createElement('script'); 
    d.type = 'text/javascript'; 
    d.async = true;
    d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
  })();
</script>


                
              </div><!-- /.entry-content -->
            </div><!-- /.entry-wrapper -->

          </article>

          <nav class="navbar nav-justified" role="navigation">
            <ul class="nav pager">
              
                <li class="previous showElem mr-auto"><a href="/blog/technology/android-versioning-using-docker-and-git-like-a-pro/" title="Android Versioning Using Docker &amp; Git Like A Pro">&larr;<span class="showPrevNex"> Previous </span> </a></li>
              
              
            </ul>
          </nav>
        
        </div><!-- /#main -->

      <!--/col-md-2 -->
      <div class="col-md-2">

      </div>

    </div><!-- /row -->
    </div>
    <div class="footer-color">
      <footer role="contentinfo">
        <center>
            <span class='footer-text'>
    &copy;  2005-<script> document.write(new Date().getFullYear()) </script>, eLitmus.com. | <a href="/terms_of_use/">Terms of Use</a> &middot; <a href="/privacy_policy/">Privacy Policy</a>

  </span>
        </center>
      </footer>
    </div><!-- /.footer-wrapper -->
    

	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'UA-707704-1', 'elitmus.com');
	  ga('send', 'pageview');
	</script>



<!-- Load Modernizr -->
<script src="/blog/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- adding jquery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- end of jquery -->

<script src="/blog/assets/js/scripts.min.js"></script>
<script src="/blog/assets/js/lunr.min.js"></script>
<script src="/blog/assets/js/lunr-search.js"></script>
<script src="/blog/assets/js/plugins/headroom.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script src="/blog/assets/js/vendor/forkit.js"></script>
  

  </body>
</html>
